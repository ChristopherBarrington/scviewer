<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Shiny App to Display Single-Cell -Seq Datasets • scviewer</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="A Shiny App to Display Single-Cell -Seq Datasets">
<meta property="og:description" content="Provides a Shiny app to display single-cell datasets.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">scviewer</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div id="scviewer" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#scviewer" class="anchor"></a>scviewer</h1></div>
<p>A lightweight single cell visualisation tool</p>
</div>
<div id="running-scviewer" class="section level1">
<h1 class="hasAnchor">
<a href="#running-scviewer" class="anchor"></a>Running scviewer</h1>
<p>This package provides the functions to create <code>h5</code> files and run an <code>scviewer</code> shiny app, see <a href="https://github.com/ChristopherBarrington/scviewer-app">scviewer-app</a> for information on configuring the app.</p>
</div>
<div id="create-an-h5-file" class="section level1">
<h1 class="hasAnchor">
<a href="#create-an-h5-file" class="anchor"></a>Create an <code>h5</code> file</h1>
<p><code>scviewer</code> expects all datasets to be saved into a properly-formatted <code>h5</code> file with keys for the following:</p>
<ul>
<li>
<code>metadata/data</code> is a <code>data.frame</code> that contains … metadata … and cluster identities</li>
<li>
<code>metadata/factor_levels</code> is a group that contains the <code>factor</code> levels for each factor in the metadata <code>data.frame</code>
</li>
<li>
<code>features</code> is a group that contains three elements:
<ul>
<li>
<code>values</code> is a group that contains the values of features that are plotted (rows of a Seurat expression matrix)</li>
<li>
<code>names</code> is a <code>vector</code> of feature names (<code>rownames</code> of a Seurat matrix)</li>
<li>
<code>cell_ids</code> is a vector of barcodes (<code>colnames</code> of a Seurat matrix)</li>
</ul>
</li>
<li>
<code>reductions</code> is a group of <code>data.frame</code> objects with coordinates for each cell in 2D and 3D space</li>
<li>
<code>cell_filter_parameters</code> is a list of metadata colums on which a filter should be permitted</li>
<li>
<code>cluster_identity_sets</code> is a list of metadata variables and default identifiers that can be used to display cell clusters with different resolutions/methods etc</li>
</ul>
</div>
<div id="convert-seurat-to-scviewer" class="section level1">
<h1 class="hasAnchor">
<a href="#convert-seurat-to-scviewer" class="anchor"></a>Convert Seurat to scviewer</h1>
<p>The following examples can be used to create a new scviewer-compatible <code>h5</code> file from a Seurat object. Some assumptions are that:</p>
<ul>
<li>features in <code>scviewer</code> are the normalised RNA and numeric meta data.</li>
<li>
<code>seurat@reductions</code> must contain a <code>pca</code> entry and describe at least 3 components. Both ‘2D’ and ‘3D’ PCA coordinates are taken from the <code>pca</code> slot.</li>
</ul>
<p>Once this repository has been cloned, the <code>scviewer</code> package can be loaded without installation:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="st">'scviewer'</span>, export_all<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>or with installation:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span>repo<span class="op">=</span><span class="st">'ChristopherBarrington/scviewer'</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">scviewer</span><span class="op">)</span></code></pre></div>
<p>To use the package to create files only, any shiny-related missing library warnings can be ignored.</p>
<p>Load the seurat object, here I use <code>readRDS</code> but any equivalent method to get an object should be fine. I also define a path into which the <code>h5</code> files should be written. Any method to define these variable would work.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">seurat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">'INPUT_SEURAT_RDS'</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">save_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">'OUTPUT_PATH'</span><span class="op">)</span> <span class="op">%T&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span>recursive<span class="op">=</span><span class="cn">TRUE</span>, showWarnings<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><strong>There is a tl;dr in the <a href="#bundling-the-whole-process">Bundling the whole process</a> section</strong></p>
<div id="required-reductions" class="section level2">
<h2 class="hasAnchor">
<a href="#required-reductions" class="anchor"></a>Required reductions</h2>
<p>To make the 2- and 3-dimension tSNE and UMAP panels, the reductions must be available in the <code>reductions</code> slot of the input Seurat object. Assuming there is a PCA <code>Reduction</code> in the object, the following will remove any other <code>Reductions</code> than <code>pca</code> and calculate tSNE and UMAP <code>Reductions</code>, where <code>n_dimensions</code> is specified.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">seurat</span> <span class="op">%&lt;&gt;%</span> <span class="fu"><a href="reference/add_all_projections.html">add_all_projections</a></span><span class="op">(</span>n_dimensions<span class="op">=</span><span class="fl">30</span><span class="op">)</span></code></pre></div>
</div>
<div id="formatting-data-from-seurat-object-and-writing-the-h5" class="section level2">
<h2 class="hasAnchor">
<a href="#formatting-data-from-seurat-object-and-writing-the-h5" class="anchor"></a>Formatting data from Seurat object and writing the h5</h2>
<p>In the following, the data from the Seurat object is parsed/formatted/wrangled and mangled into structures that are written into the <code>h5</code> file.</p>
<div id="create-the-h5-file" class="section level3">
<h3 class="hasAnchor">
<a href="#create-the-h5-file" class="anchor"></a>Create the <code>h5</code> file</h3>
<p>An empty <code>h5</code> formatted file is created here. If the file exists, it should be deleted beforehand otherwise this command will fail. If an existing <code>h5</code> file is used as <code>h5_file</code> the groups written will be deleted from the file before being re-written by the following functions.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">h5_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">save_path</span>, <span class="fu">str_c</span><span class="op">(</span><span class="fu">Project</span><span class="op">(</span><span class="va">seurat</span><span class="op">)</span>, <span class="st">'.scv'</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="reference/create_h5_scv.html">create_h5_scv</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span><span class="op">)</span></code></pre></div>
</div>
<div id="reductions" class="section level3">
<h3 class="hasAnchor">
<a href="#reductions" class="anchor"></a>Reductions</h3>
<p>The following extracts all of the reductions in the Seurat object into a list of <code>data.frame</code> objects.</p>
<p>An assumption here is that for each reduction method (eg UMAP) there are two reduction objects: <code>umap</code> and <code>umap_3d</code> for example. If you don’t have those embeddings, you can use <code>RunUMAP</code> to add them to your Seurat object or try using <code>scviewer::add_all_reductions()</code>.</p>
<p>For the PCA reduction, the first three components are selected to make the <code>pca_3d</code> data from the <code>pca</code> reduction then the first two are selected to make the 2D version.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="op">&gt;</span><span class="st"> </span>reductions &lt;-<span class="st"> </span>scviewer<span class="op">:::</span><span class="kw">guess_reductions</span>(seurat)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="op">&gt;</span><span class="st"> </span><span class="kw">lapply</span>(reductions, head, <span class="dt">n=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="op">$</span>pca</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">             cell_id         x           y</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="dv">1</span> AAACCCACACCTCTGT<span class="dv">-1</span>  <span class="fl">1.934101</span>  <span class="fl">3.70549631</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="dv">2</span> AAACCCAGTAAGAACT<span class="dv">-1</span> <span class="fl">-6.095149</span>  <span class="fl">2.35777169</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="dv">3</span> AAACGAAAGACTGAGC<span class="dv">-1</span> <span class="fl">11.628598</span> <span class="fl">-0.09594123</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="op">$</span>tsne</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">             cell_id          x         y</a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="dv">1</span> AAACCCACACCTCTGT<span class="dv">-1</span>   <span class="fl">7.718922</span> <span class="fl">15.008067</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="dv">2</span> AAACCCAGTAAGAACT<span class="dv">-1</span>   <span class="fl">1.156841</span> <span class="fl">-5.977375</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="dv">3</span> AAACGAAAGACTGAGC<span class="dv">-1</span> <span class="fl">-24.378159</span> <span class="fl">25.883702</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="op">$</span>tsne_3d</a>
<a class="sourceLine" id="cb6-16" data-line-number="16">             cell_id         x         y           z</a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="dv">1</span> AAACCCACACCTCTGT<span class="dv">-1</span> <span class="fl">-20.08531</span> <span class="fl">-6.058905</span>   <span class="fl">0.7906353</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="dv">2</span> AAACCCAGTAAGAACT<span class="dv">-1</span>  <span class="fl">-1.68918</span>  <span class="fl">5.855843</span> <span class="fl">-29.6971474</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="dv">3</span> AAACGAAAGACTGAGC<span class="dv">-1</span> <span class="fl">-13.84951</span>  <span class="fl">4.869889</span>  <span class="fl">43.4326906</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="op">$</span>umap</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">             cell_id         x         y</a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="dv">1</span> AAACCCACACCTCTGT<span class="dv">-1</span> <span class="fl">-1.345953</span>  <span class="fl">1.311305</span></a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="dv">2</span> AAACCCAGTAAGAACT<span class="dv">-1</span>  <span class="fl">4.432537</span>  <span class="fl">2.619599</span></a>
<a class="sourceLine" id="cb6-25" data-line-number="25"><span class="dv">3</span> AAACGAAAGACTGAGC<span class="dv">-1</span> <span class="fl">-6.841505</span> <span class="fl">-1.717847</span></a>
<a class="sourceLine" id="cb6-26" data-line-number="26"></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="op">$</span>umap_3d</a>
<a class="sourceLine" id="cb6-28" data-line-number="28">             cell_id          x         y         z</a>
<a class="sourceLine" id="cb6-29" data-line-number="29"><span class="dv">1</span> AAACCCACACCTCTGT<span class="dv">-1</span>  <span class="fl">1.1464871</span>  <span class="fl">1.226989</span> <span class="fl">-1.242662</span></a>
<a class="sourceLine" id="cb6-30" data-line-number="30"><span class="dv">2</span> AAACCCAGTAAGAACT<span class="dv">-1</span> <span class="fl">-0.9679188</span> <span class="fl">-2.856427</span> <span class="fl">-1.369519</span></a>
<a class="sourceLine" id="cb6-31" data-line-number="31"><span class="dv">3</span> AAACGAAAGACTGAGC<span class="dv">-1</span>  <span class="fl">5.5932413</span>  <span class="fl">2.799470</span>  <span class="fl">1.500001</span></a>
<a class="sourceLine" id="cb6-32" data-line-number="32"></a>
<a class="sourceLine" id="cb6-33" data-line-number="33"><span class="op">$</span>pca_3d</a>
<a class="sourceLine" id="cb6-34" data-line-number="34">             cell_id         x           y         z</a>
<a class="sourceLine" id="cb6-35" data-line-number="35"><span class="dv">1</span> AAACCCACACCTCTGT<span class="dv">-1</span>  <span class="fl">1.934101</span>  <span class="fl">3.70549631</span> <span class="fl">-6.434000</span></a>
<a class="sourceLine" id="cb6-36" data-line-number="36"><span class="dv">2</span> AAACCCAGTAAGAACT<span class="dv">-1</span> <span class="fl">-6.095149</span>  <span class="fl">2.35777169</span> <span class="fl">-4.475791</span></a>
<a class="sourceLine" id="cb6-37" data-line-number="37"><span class="dv">3</span> AAACGAAAGACTGAGC<span class="dv">-1</span> <span class="fl">11.628598</span> <span class="fl">-0.09594123</span>  <span class="fl">1.120231</span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38"></a>
<a class="sourceLine" id="cb6-39" data-line-number="39"><span class="op">&gt;</span></a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/write_reductions.html">write_reductions</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, seurat<span class="op">=</span><span class="va">seurat</span><span class="op">)</span> <span class="co"># uses `guess_reductions` to collect coordinates</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/write_reductions.html">write_reductions</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, reductions<span class="op">=</span><span class="va">reductions</span><span class="op">)</span> <span class="co"># user-defined coordinates list</span></code></pre></div>
</div>
<div id="feature-values" class="section level3">
<h3 class="hasAnchor">
<a href="#feature-values" class="anchor"></a>Feature values</h3>
<p>By default, the values of RNA features are extracted into a matrix and can be appended with any other numeric meta data. Any numeric data can be added here so that they can be plotted in the viewer as a feature. This matrix can be automatically created by <code>write_features</code> using <code>guess_features_matrix</code> when the <code>features_matrix</code> argument is omitted.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="op">&gt;</span><span class="st"> </span>features_matrix &lt;-<span class="st"> </span>scviewer<span class="op">:::</span><span class="kw">guess_features_matrix</span>(seurat)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="op">&gt;</span><span class="st"> </span>features_matrix[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="kw">c</span>(<span class="st">'COX3'</span>, <span class="st">'RPS12'</span>, <span class="st">'percent_mt'</span>, <span class="st">'nFeature_RNA'</span>, <span class="st">'nCount_RNA'</span>)]</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">                       COX3    RPS12 percent_mt nFeature_RNA nCount_RNA</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">AAACCCACACCTCTGT<span class="dv">-1</span> <span class="fl">4.811714</span> <span class="fl">4.817744</span>   <span class="fl">4.610008</span>         <span class="dv">2225</span>      <span class="dv">13449</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">AAACCCAGTAAGAACT<span class="dv">-1</span> <span class="fl">4.468762</span> <span class="fl">4.881488</span>   <span class="fl">3.730982</span>         <span class="dv">1831</span>      <span class="dv">10319</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">AAACGAAAGACTGAGC<span class="dv">-1</span> <span class="fl">4.244721</span> <span class="fl">4.617961</span>   <span class="fl">3.177644</span>         <span class="dv">3048</span>      <span class="dv">17749</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">AAACGAAAGGCTCTAT<span class="dv">-1</span> <span class="fl">4.787714</span> <span class="fl">4.974337</span>   <span class="fl">5.194957</span>         <span class="dv">2634</span>      <span class="dv">17055</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">AAACGAAGTGAGCCAA<span class="dv">-1</span> <span class="fl">4.458634</span> <span class="fl">4.937042</span>   <span class="fl">3.297027</span>         <span class="dv">1456</span>       <span class="dv">6794</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">AAACGCTAGACCAGAC<span class="dv">-1</span> <span class="fl">4.841800</span> <span class="fl">4.738045</span>   <span class="fl">6.368101</span>         <span class="dv">2452</span>      <span class="dv">12013</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">AAACGCTCAAGGCTTT<span class="dv">-1</span> <span class="fl">4.744864</span> <span class="fl">4.509862</span>   <span class="fl">4.752348</span>         <span class="dv">2387</span>      <span class="dv">12457</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">AAACGCTCAGACGCTC<span class="dv">-1</span> <span class="fl">4.959195</span> <span class="fl">4.717896</span>   <span class="fl">6.495177</span>         <span class="dv">2369</span>      <span class="dv">12440</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">AAACGCTCATCAGTGT<span class="dv">-1</span> <span class="fl">5.197880</span> <span class="fl">4.598387</span>   <span class="fl">6.815642</span>         <span class="dv">1984</span>       <span class="dv">8950</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">AAACGCTGTAGATTAG<span class="dv">-1</span> <span class="fl">4.911110</span> <span class="fl">4.777138</span>   <span class="fl">5.093644</span>         <span class="dv">2539</span>      <span class="dv">14096</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="op">&gt;</span></a></code></pre></div>
<p>(This is the slow bit). For every feature, a new element in the <code>h5</code> file is written; each feature is a key in the <code>feature/values</code> location. Feature names are converted here to lower case, since the retrieval from the app is case-sensitive.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/write_features.html">write_features</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, seurat<span class="op">=</span><span class="va">seurat</span><span class="op">)</span> <span class="co"># uses `guess_features_matrix` to collect normalised RNA and numeric meta data</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/write_features.html">write_features</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, features_matrix<span class="op">=</span><span class="va">features_matrix</span><span class="op">)</span> <span class="co"># user-defined feature values matrix</span></code></pre></div>
<div id="module-scores" class="section level4">
<h4 class="hasAnchor">
<a href="#module-scores" class="anchor"></a>Module scores</h4>
<p>If the <code>Seurat</code> object contains numeric variables in the <code>meta.data</code> slot, these will be added to the feature matrix. To tell <code>scviewer</code> what type of feature these are, the <code>feature_types</code> argument can be defined, if not everything is assumed to be a ‘count’.</p>
<p>The following list adds all of the ‘normal’ features from the matrix into ‘count’ and selects the <code>seurat@meta.data</code> variables (which will become features) that start with ‘ModuleScore’.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feature_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">seurat</span><span class="op">)</span>, module_score<span class="op">=</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">seurat</span><span class="op">@</span><span class="va">meta.data</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">str_subset</span><span class="op">(</span><span class="st">'^ModuleScore:'</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="reference/write_features.html">write_features</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, seurat<span class="op">=</span><span class="va">seurat</span>, feature_types<span class="op">=</span><span class="va">feature_types</span><span class="op">)</span> <span class="co"># uses `guess_features_matrix` to collect normalised RNA and numeric meta data</span></code></pre></div>
</div>
</div>
<div id="dataset-metadata" class="section level3">
<h3 class="hasAnchor">
<a href="#dataset-metadata" class="anchor"></a>Dataset metadata</h3>
<p>The metadata is extracted and subset. Any cell filters need to be defined here - these are one or more variables that can be used to determine if a cell should be displayed. The logic uses <code><a href="https://rdrr.io/r/base/match.html">%in%</a></code> to identify cells whose filter value is selected. In this example, I create a <code>dataset_filter</code> which reformats the <code>orig.ident</code> and adds in the number of cells in the filter. Cluster identities are defined here too, keeping any variable with the ‘_snn_res’ string in this case. But these variables are completely flexible, any names and any content.</p>
<p>The filter and cluster variables are converted to factors and their levels ordered; the order of levels here is the order of the levels in the app.</p>
<p>The code below shows how the meta data table can be customised and provided. If omitted, any non-numeric variables of <code>seurat@meta.data</code> will be exported and converted to factors by <code>guess_metadata</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="op">&gt;</span><span class="st"> </span>seurat<span class="op">@</span>meta.data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="op">+</span><span class="st">   </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="op">+</span><span class="st">   </span><span class="kw">rownames_to_column</span>(<span class="st">'cell_id'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="op">+</span><span class="st">   </span><span class="kw">mutate</span>(<span class="dt">datasets_filter=</span><span class="kw">str_replace</span>(orig.ident, <span class="st">'_'</span>, <span class="st">' '</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="op">+</span><span class="st">   </span><span class="kw">select</span>(datasets_filter, cell_id, <span class="kw">contains</span>(<span class="st">'_snn_res.'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="op">+</span><span class="st">   </span><span class="kw">group_by</span>(datasets_filter) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="op">+</span><span class="st">   </span><span class="kw">mutate</span>(<span class="dt">N=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="op">+</span><span class="st">   </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="op">+</span><span class="st">   </span><span class="kw">mutate</span>(<span class="dt">datasets_filter=</span>{<span class="kw">sprintf</span>(<span class="dt">fmt=</span><span class="st">'%s (n=%s)'</span>, datasets_filter, <span class="kw">comma</span>(N)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">factor</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fct_relevel</span>({<span class="kw">levels</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mixedsort</span>()})}) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="op">+</span><span class="st">   </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="kw">contains</span>(<span class="st">'_snn_res.'</span>)), <span class="cf">function</span>(x) x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fct_relevel</span>({<span class="kw">levels</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mixedsort</span>()})) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="op">+</span><span class="st">   </span><span class="kw">select</span>(<span class="op">-</span>N) -&gt;<span class="st"> </span>metadata</a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="er">&gt;</span><span class="st"> </span>metadata[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">7</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>()</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">  datasets_filter            cell_id RNA_snn_res.<span class="fl">0.2</span> RNA_snn_res.<span class="fl">0.4</span> RNA_snn_res.<span class="fl">0.6</span> RNA_snn_res.<span class="fl">0.8</span> RNA_snn_res<span class="fl">.1</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="dv">1</span>     <span class="kw">E85</span> (<span class="dt">n=</span><span class="dv">477</span>) AAACCCAAGTTAACGA<span class="dv">-1</span>               <span class="dv">0</span>               <span class="dv">2</span>               <span class="dv">1</span>               <span class="dv">1</span>             <span class="dv">1</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="dv">2</span>     <span class="kw">E85</span> (<span class="dt">n=</span><span class="dv">477</span>) AAAGGATAGTAGACCG<span class="dv">-1</span>               <span class="dv">1</span>               <span class="dv">0</span>               <span class="dv">2</span>               <span class="dv">2</span>             <span class="dv">2</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="dv">3</span>     <span class="kw">E85</span> (<span class="dt">n=</span><span class="dv">477</span>) AAATGGATCGAACACT<span class="dv">-1</span>               <span class="dv">0</span>               <span class="dv">1</span>               <span class="dv">0</span>               <span class="dv">0</span>             <span class="dv">0</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="dv">4</span>     <span class="kw">E85</span> (<span class="dt">n=</span><span class="dv">477</span>) AACAAAGTCCGACATA<span class="dv">-1</span>               <span class="dv">0</span>               <span class="dv">1</span>               <span class="dv">0</span>               <span class="dv">0</span>             <span class="dv">0</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="dv">5</span>     <span class="kw">E85</span> (<span class="dt">n=</span><span class="dv">477</span>) AACAACCAGATCCTAC<span class="dv">-1</span>               <span class="dv">0</span>               <span class="dv">2</span>               <span class="dv">1</span>               <span class="dv">1</span>             <span class="dv">1</span></a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="op">&gt;</span></a></code></pre></div>
<p>Now the <code>metadata</code> is now written to the <code>h5_file</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/write_metadata.html">write_metadata</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, seurat<span class="op">=</span><span class="va">seurat</span><span class="op">)</span> <span class="co"># uses `guess_metadata` to collect factor meta data</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/write_metadata.html">write_metadata</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, metadata<span class="op">=</span><span class="va">metadata</span><span class="op">)</span> <span class="co"># user-defined metadata</span></code></pre></div>
</div>
<div id="cell-clusters" class="section level3">
<h3 class="hasAnchor">
<a href="#cell-clusters" class="anchor"></a>Cell clusters</h3>
<p>A list is created that determines which cluster sets to include in the drop down selector and which cluster identities should be shown by default. Here, I take all of the cluster sets in the meta data table and show all cluster identities by default. The final output of this chunk is a list of lists. Each index of the first-level list is named according to the meta data variable. The second-level list contains:</p>
<ul>
<li>
<code>var</code> the meta data variable</li>
<li>
<code>name</code> a name for the cluster set to be shown in the drop down - here the clustering resolution is appended to ‘Res.’</li>
<li>
<code>selected</code> is a vector of cluster identities (which should be levels of the <code>var</code>) to show by default</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="op">&gt;</span><span class="st"> </span>cluster_identity_sets &lt;-<span class="st"> </span><span class="kw">guess_cluster_identity_sets</span>(seurat)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="op">&gt;</span><span class="st"> </span><span class="kw">head</span>(cluster_identity_sets, <span class="dt">n=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="op">$</span>RNA_snn_res.<span class="fl">0.2</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="op">$</span>RNA_snn_res.<span class="fl">0.2</span><span class="op">$</span>var</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">[<span class="dv">1</span>] <span class="st">"RNA_snn_res.0.2"</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="op">$</span>RNA_snn_res.<span class="fl">0.2</span><span class="op">$</span>name</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">[<span class="dv">1</span>] <span class="st">"Res. 0.2"</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="op">$</span>RNA_snn_res.<span class="fl">0.2</span><span class="op">$</span>selected</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">[<span class="dv">1</span>] <span class="st">"0"</span> <span class="st">"1"</span> <span class="st">"2"</span> <span class="st">"3"</span> <span class="st">"4"</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"></a>
<a class="sourceLine" id="cb16-14" data-line-number="14"><span class="op">$</span>RNA_snn_res.<span class="fl">0.4</span></a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="op">$</span>RNA_snn_res.<span class="fl">0.4</span><span class="op">$</span>var</a>
<a class="sourceLine" id="cb16-16" data-line-number="16">[<span class="dv">1</span>] <span class="st">"RNA_snn_res.0.4"</span></a>
<a class="sourceLine" id="cb16-17" data-line-number="17"></a>
<a class="sourceLine" id="cb16-18" data-line-number="18"><span class="op">$</span>RNA_snn_res.<span class="fl">0.4</span><span class="op">$</span>name</a>
<a class="sourceLine" id="cb16-19" data-line-number="19">[<span class="dv">1</span>] <span class="st">"Res. 0.4"</span></a>
<a class="sourceLine" id="cb16-20" data-line-number="20"></a>
<a class="sourceLine" id="cb16-21" data-line-number="21"><span class="op">$</span>RNA_snn_res.<span class="fl">0.4</span><span class="op">$</span>selected</a>
<a class="sourceLine" id="cb16-22" data-line-number="22">[<span class="dv">1</span>] <span class="st">"0"</span> <span class="st">"1"</span> <span class="st">"2"</span> <span class="st">"3"</span> <span class="st">"4"</span> <span class="st">"5"</span> <span class="st">"6"</span></a>
<a class="sourceLine" id="cb16-23" data-line-number="23"></a>
<a class="sourceLine" id="cb16-24" data-line-number="24"></a>
<a class="sourceLine" id="cb16-25" data-line-number="25"><span class="op">$</span>RNA_snn_res.<span class="fl">0.6</span></a>
<a class="sourceLine" id="cb16-26" data-line-number="26"><span class="op">$</span>RNA_snn_res.<span class="fl">0.6</span><span class="op">$</span>var</a>
<a class="sourceLine" id="cb16-27" data-line-number="27">[<span class="dv">1</span>] <span class="st">"RNA_snn_res.0.6"</span></a>
<a class="sourceLine" id="cb16-28" data-line-number="28"></a>
<a class="sourceLine" id="cb16-29" data-line-number="29"><span class="op">$</span>RNA_snn_res.<span class="fl">0.6</span><span class="op">$</span>name</a>
<a class="sourceLine" id="cb16-30" data-line-number="30">[<span class="dv">1</span>] <span class="st">"Res. 0.6"</span></a>
<a class="sourceLine" id="cb16-31" data-line-number="31"></a>
<a class="sourceLine" id="cb16-32" data-line-number="32"><span class="op">$</span>RNA_snn_res.<span class="fl">0.6</span><span class="op">$</span>selected</a>
<a class="sourceLine" id="cb16-33" data-line-number="33">[<span class="dv">1</span>] <span class="st">"0"</span> <span class="st">"1"</span> <span class="st">"2"</span> <span class="st">"3"</span> <span class="st">"4"</span> <span class="st">"5"</span> <span class="st">"6"</span> <span class="st">"7"</span> <span class="st">"8"</span></a>
<a class="sourceLine" id="cb16-34" data-line-number="34"></a>
<a class="sourceLine" id="cb16-35" data-line-number="35"></a>
<a class="sourceLine" id="cb16-36" data-line-number="36"><span class="op">&gt;</span></a></code></pre></div>
<p>The list of cell cluster information that was defined above is written to the <code>h5</code> file as a list. The default behaviour (above) can be automatically applied by omitting the <code>cluster_identity_sets</code> argument.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/write_cluster_identity_sets.html">write_cluster_identity_sets</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, seurat<span class="op">=</span><span class="va">seurat</span><span class="op">)</span> <span class="co"># uses `guess_cluster_identity_sets` to collect cluster sets</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/write_cluster_identity_sets.html">write_cluster_identity_sets</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, cluster_identity_sets<span class="op">=</span><span class="va">cluster_identity_sets</span><span class="op">)</span> <span class="co"># user-defined cluster definitions</span></code></pre></div>
</div>
<div id="cell-filters" class="section level3">
<h3 class="hasAnchor">
<a href="#cell-filters" class="anchor"></a>Cell filters</h3>
<p>The list of cell filters here is used to create the drop down UI elements and filter the cells. The list is named according to the label that should be displayed next to the UI element and the <code>var</code> element is the variable in the meta data that should be filtered. Filters are not required and can be omitted, if there are none.</p>
<p>In this example, I define filters only for the ‘datasets_filter’ variable and specify that one dataset should be selected by default. (is functionality even working?!)</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cell_filter_parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`Constituent datasets`<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>var<span class="op">=</span><span class="st">'datasets_filter'</span>, selected<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'E85 (n=477)'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
<span class="fu"><a href="reference/write_cell_filter_parameters.html">write_cell_filter_parameters</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, cell_filter_parameters<span class="op">=</span><span class="va">cell_filter_parameters</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="bundling-the-whole-process" class="section level2">
<h2 class="hasAnchor">
<a href="#bundling-the-whole-process" class="anchor"></a>Bundling the whole process</h2>
<p>The following wrapper function <em>could</em> work. No cell filters are applied!</p>
<p>It will :</p>
<ul>
<li>use <code>readRDS</code> to read <code>seurat</code> when <code>seurat</code> is a character</li>
<li>recalculate the tSNE and UMAP projections in 2D and 3D (if <code>recalculate_reductions=TRUE</code>)</li>
<li>run<code>write_reductions</code>
</li>
<li>run<code>write_feature_values</code>
</li>
<li>run<code>write_metadata</code>
</li>
<li>run<code>write_cluster_identity_sets</code>
</li>
</ul>
<p>Once the <code>h5</code> file is written, each component can be modified using the examples above.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/seurat_to_scv.html">seurat_to_scv</a></span><span class="op">(</span>h5_file<span class="op">=</span><span class="va">h5_file</span>, seurat<span class="op">=</span><span class="va">seurat</span>, recalculate_reductions<span class="op">=</span><span class="cn">TRUE</span>, n_dimensions<span class="op">=</span><span class="fl">40</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="configuration-file" class="section level1">
<h1 class="hasAnchor">
<a href="#configuration-file" class="anchor"></a>Configuration file</h1>
<p>The <code>yaml</code> configuration file contains parameters for the session. The <code>datasets</code> section of the configuration file is used to populate the dataset selection dropdown. It is a two-level list: the first level denotes groups within the dropdown (eg. species) and the second denotes datasets (eg. samples). Each dataset must contain a <code>file</code> key which is the path to a properly -formatted <code>h5</code> file (as described above).</p>
<p>The top-level <code>initial_feature</code> key can be used to define an initial feature that is displayed for all datasets in the instance. This can be overridden by specifying the <code>initial_feature</code> at any level of the configuration.</p>
<p>Ignore the <code>tracker</code>.</p>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>What license it uses</li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Christopher Barrington <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0003-1281-2658" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by Christopher Barrington.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
